name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  # ============================================
  # TRIVY - Vulnerability Scanner
  # ============================================
  trivy:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

      - name: Run Trivy (table output for PR comments)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true
        continue-on-error: true  # Don't fail on unfixed vulns

  # ============================================
  # TRUFFLEHOG - Secrets Scanner
  # ============================================
  trufflehog:
    name: TruffleHog Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: TruffleHog scan (PR)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

      - name: TruffleHog scan (push)
        if: github.event_name == 'push'
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true  # May fail on first push
        with:
          path: ./
          extra_args: --only-verified --since-commit ${{ github.event.before }}

      - name: TruffleHog full scan (fallback)
        if: github.event_name == 'push' && github.event.before == '0000000000000000000000000000000000000000'
        run: |
          echo "First push detected, running full repository scan"
          docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:latest filesystem /pwd --only-verified

  # ============================================
  # PYTHON SECURITY SCANNERS
  # ============================================
  python-security:
    name: Python Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          pip install --upgrade pip
          pip install bandit safety pip-audit

      # ------------------------------------------
      # BANDIT - Python code security linter
      # ------------------------------------------
      - name: Run Bandit (code security)
        run: |
          bandit -r . -x ./tests,./.venv,./venv -f json -o bandit-report.json || true
          bandit -r . -x ./tests,./.venv,./venv -f txt -o bandit-report.txt || true
          echo "### Bandit Security Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat bandit-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

      - name: Bandit check (fail on high severity)
        run: |
          bandit -r . -x ./tests,./.venv,./venv -ll -ii
        continue-on-error: true  # Warning only for now

      # ------------------------------------------
      # PIP-AUDIT - Dependency vulnerability scan
      # ------------------------------------------
      - name: Install project dependencies
        run: |
          pip install -r requirements.txt || true

      - name: Run pip-audit (dependency vulnerabilities)
        run: |
          pip-audit --format json --output pip-audit-report.json || true
          echo "### Pip-Audit Dependency Report" >> $GITHUB_STEP_SUMMARY
          pip-audit || echo "No critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-report
          path: pip-audit-report.json

      # ------------------------------------------
      # SAFETY - Another dependency checker
      # ------------------------------------------
      - name: Run Safety (dependency check)
        run: |
          safety check -r requirements.txt || true
        continue-on-error: true

  # ============================================
  # SEMGREP - Static Analysis (separate action)
  # ============================================
  semgrep:
    name: Semgrep Static Analysis
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep --config=auto --json --output=semgrep-report.json . || true
          semgrep --config=auto . || true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: Upload Semgrep report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-report
          path: semgrep-report.json

  # ============================================
  # SUMMARY JOB
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [trivy, trufflehog, python-security, semgrep]
    if: always()
    steps:
      - name: Security scan results
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | ${{ needs.trivy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TruffleHog | ${{ needs.trufflehog.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Security | ${{ needs.python-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep | ${{ needs.semgrep.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Some tools may show as 'success' even with warnings." >> $GITHUB_STEP_SUMMARY
